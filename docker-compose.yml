services:
  api:
    build: .
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - PREFECT_API_URL=http://prefect:4200/api
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    volumes:
      - ml-registry:/app/ml/registry
      - ml-features:/app/ml/features
      - ml-data:/app/ml/data

  prefect-worker:
    build: .
    depends_on:
      prefect:
        condition: service_started
      prefect-init:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - PREFECT_API_URL=http://prefect:4200/api
      - PREFECT_WORK_POOL=thalassa-pool
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    volumes:
      - ml-registry:/app/ml/registry
      - ml-features:/app/ml/features
      - ml-data:/app/ml/data
    command: ["prefect", "worker", "start", "-p", "thalassa-pool"]
    restart: unless-stopped

  prefect-init:
    build: .
    depends_on:
      - prefect
    env_file:
      - .env
    environment:
      - PREFECT_API_URL=http://prefect:4200/api
      - PREFECT_WORK_POOL=thalassa-pool
      - PREFECT_DEPLOYMENT_NAME=scheduled
      - PREFECT_SCHEDULE_CRON=0 * * * *
      - PREFECT_SCHEDULE_TZ=UTC
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    volumes:
      - ml-registry:/app/ml/registry
      - ml-features:/app/ml/features
      - ml-data:/app/ml/data
    command: ["python", "tools/prefect_bootstrap.py"]
    restart: "no"

  prefect:
    build: .
    command: prefect server start --host 0.0.0.0
    ports:
      - "4200:4200"
    volumes:
      - prefect-data:/root/.prefect

volumes:
  ml-registry:
  ml-features:
  ml-data:
  prefect-data:
