{% extends 'base.html' %}
{% block content %}
<section class="section-header">
  <h1>Single Classification</h1>
  <div class="toolbar">
    <a class="btn" href="/tasks{% if ticker %}?ticker={{ ticker }}{% endif %}">← Back to ML Tasks</a>
    <span class="muted">Ticker: <strong>{{ ticker or 'AAPL' }}</strong></span>
  </div>
</section>
</section>
{# Top duplicate of Expected Features removed. Features are shown in the horizontal layout below. #}

{# Pipeline Summary moved further down to sit under the main layout. #}

<!-- Model summary card -->
{# Model Summary moved into the horizontal layout below. #}

<!-- Horizontal layout: Model Summary | Expected Features | Feature Values -->
<div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;margin-top:12px">
  <div style="flex:1;min-width:300px;">
    <section class="panel">
      <h4>Model Summary</h4>
      {% if model_meta %}
        <p><strong>Model:</strong> {{ model_meta.get('model') or model_meta.get('name') or 'xgb_classifier' }}</p>
        <p><strong>Created:</strong> {{ model_meta.get('created') or model_meta.get('created_at') }}</p>
        <p><strong>Features:</strong> {{ (model_meta.get('features')|length) if model_meta.get('features') else 'N/A' }}</p>
        {% if model_meta.get('metrics') %}
        {% endif %}
      {% else %}
        <p class="muted">No trained classifier metadata found for this ticker.</p>
      {% endif %}
    </section>
  </div>

  <div style="flex:1;min-width:320px;">
    <section class="panel">
      <h4>Expected Features</h4>
      {% if features %}
        <div class="feature-tokens" style="margin-top:8px; display:flex;flex-wrap:wrap;gap:6px;">
          {% for f in features %}
            <span class="feature-chip" title="{{ f }}" data-feature="{{ f }}">{{ tokens.get(f, f[:6]) }}</span>
          {% endfor %}
        </div>
        <div id="featureDetail" class="panel" style="display:none; margin-top:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div>
              <div id="featureDetailName" style="font-weight:700"></div>
              <div id="featureDetailDef" class="muted" style="margin-top:6px"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="featureCopy" class="btn small">Copy</button>
              <button id="featureClose" class="btn small btn-outline">Close</button>
            </div>
          </div>
        </div>
      {% else %}
        <p class="muted">Classifier not trained yet. Train the classifier or run the pipeline.</p>
      {% endif %}
    </section>
  </div>

  <div style="flex:1;min-width:320px;">
    <section class="panel">
      <h4>Feature Values</h4>
      <form action="/classify" method="post" class="form">
        <input type="hidden" name="ticker" value="{{ ticker or '' }}" />
        <div class="form-control">
          <label for="values">Feature Values (comma-separated)</label>
          <input id="values" type="text" name="values" placeholder="e.g. 0.1, 0.2, 0.3, ..." required />
          <small class="hint">Order must match the expected features shown in the middle column.</small>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Classify</button>
        </div>
      </form>
      {% if result %}
      <div style="margin-top:10px">
        <section class="panel">
          <h3>Result</h3>
          <p>Probability Up: <strong>{{ '%.4f'|format(result.proba_up) }}</strong></p>
          <p>Label: <strong>{{ result.label }}</strong> (1 = Up, 0 = Down)</p>
        </section>
      </div>
      {% endif %}
    </section>
  </div>
</div>

<!-- Pipeline Summary: moved here to appear below Model/Features/Form -->
<div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;margin-top:12px;margin-bottom:12px">
  <div style="flex:1;min-width:280px;">
    <div class="card">
      <h3>Pipeline Summary</h3>
      {% if prediction %}
        <div class="detail-kv" style="margin-top:6px">
          <div class="detail-row"><div class="detail-key">Source date</div><div class="detail-val"><strong>{{ prediction.source_date }}</strong></div></div>
          <div class="detail-row"><div class="detail-key">Prediction (tomorrow)</div><div class="detail-val"><strong>{{ prediction.label == 1 and 'Up' or 'Down' }}</strong> — {{ '%.3f'|format(prediction.proba_up) }}</div></div>
        </div>
      {% else %}
        <div class="muted">No pipeline prediction available for this ticker. Run the pipeline to generate one.</div>
      {% endif %}
    </div>
  </div>

  <div style="flex:1;min-width:280px;">
    <div class="card">
      <h3>Metrics & Calibration</h3>
      {% if model_meta and model_meta.get('metrics') %}
        {% set m = model_meta.get('metrics') %}
        {% set s = model_meta.get('samples') %}
        <div class="detail-kv" style="margin-top:6px">
          <div class="detail-row"><div class="detail-key">Logloss</div><div class="detail-val">{{ '%.4f'|format(m.get('logloss_val')) if m.get('logloss_val') is not none else ('%.4f'|format(m.get('logloss')) if m.get('logloss') is not none else '—') }}</div></div>
          <div class="detail-row"><div class="detail-key">AUC</div><div class="detail-val">{{ '%.4f'|format(m.get('auc_val')) if m.get('auc_val') is not none else ('%.4f'|format(m.get('auc')) if m.get('auc') is not none else '—') }}</div></div>
          <div class="detail-row"><div class="detail-key">Samples</div><div class="detail-val">{% if s %}{{ s.get('total') }} (train={{ s.get('train') }}, val={{ s.get('val') }}){% else %}&mdash;{% endif %}</div></div>
        </div>
        
      {% else %}
        <div class="muted">No model metrics available.</div>
      {% endif %}

      {% if calibration %}
        <div style="margin-top:10px">
          <div class="detail-kv">
            <div class="detail-row"><div class="detail-key">Prob. band (95%)</div><div class="detail-val">{% if calibration.band %}{{ '%.3f'|format(calibration.band.lower) }}–{{ '%.3f'|format(calibration.band.upper) }} (n={{ calibration.band.n }}){% else %}&mdash;{% endif %}</div></div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div style="flex:1;min-width:320px;">
    <div class="card">
      <h3>Reliability / Calibration</h3>
      {% if reliability %}
        {% if reliability.brier is not none %}
          <div class="detail-kv" style="margin-top:6px">
            <div class="detail-row"><div class="detail-key">Brier</div><div class="detail-val">{{ '%.4f'|format(reliability.brier) }}</div></div>
            <div class="detail-row"><div class="detail-key">Samples</div><div class="detail-val">{{ reliability.n }}</div></div>
          </div>
        {% endif %}
        <div class="muted" style="margin-top:6px">Shown by probability bin: predicted vs observed frequency.</div>
        <div style="margin-top:10px" class="detail-kv">
          {% for i in range(reliability.prob_pred|length) %}
            {% set p_pred = reliability.prob_pred[i] %}
            {% set p_true = reliability.prob_true[i] %}
            {% set assess = (reliability.assess[i] if reliability.assess is defined and reliability.assess|length > i else '') %}
            {% set color = 'var(--primary)' %}
            {% if assess == 'Good' %}
              {% set color = '#48c774' %}
            {% elif assess == 'Over' %}
              {% set color = '#ff6b6b' %}
            {% elif assess == 'Under' %}
              {% set color = '#ff9f43' %}
            {% else %}
              {% set color = 'var(--muted)' %}
            {% endif %}
            <div class="detail-row" style="display:flex;align-items:center;gap:8px;">
              <div style="min-width:72px;display:flex;align-items:center;gap:8px;">
                {% if assess %}
                  <span style="background:{% if color %}{{ color }}{% endif %};color:#fff;padding:4px 8px;border-radius:8px;font-weight:600;font-size:12px">{{ assess }}</span>
                {% endif %}
                <div class="detail-key">Bin {{ i+1 }}</div>
              </div>
              <div class="detail-val">pred {{ p_pred is not none and '%.3f'|format(p_pred) or '—' }} · obs {{ p_true is not none and '%.3f'|format(p_true) or '—' }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No reliability data available. Run the pipeline or train the model to compute calibration.</div>
      {% endif %}
    </div>
  </div>
</div>

<div style="margin-top:12px">
  <section class="panel">
    <h4>Glossary</h4>
    <div style="margin-top:6px">
      <div class="gloss-item" style="margin-top:6px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-logloss" aria-expanded="false">Logloss ▸</button>
        <div id="gloss-logloss" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <strong>Logloss</strong>: lower is better; measures how well predicted probabilities match actual outcomes. Very small values can indicate excellent fit or overfitting.
        </div>
      </div>

      <div class="gloss-item" style="margin-top:8px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-auc" aria-expanded="false">AUC ▸</button>
        <div id="gloss-auc" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <strong>AUC</strong>: closer to 1.0 is better; measures ranking/separation ability.
        </div>
      </div>
      
      <div class="gloss-item" style="margin-top:8px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-brier" aria-expanded="false">Brier score ▸</button>
        <div id="gloss-brier" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <strong>Brier score</strong>: the mean squared error of probabilistic predictions for binary outcomes. Computed as the average of (predicted_prob − actual_label)^2 over examples. Lower is better (0 is perfect). Use the Brier score to assess how close predicted probabilities are to observed outcomes.
        </div>
      </div>

      <div class="gloss-item" style="margin-top:8px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-bins" aria-expanded="false">Bins ▸</button>
        <div id="gloss-bins" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <strong>Bins</strong>: predicted probabilities are grouped into discrete ranges (e.g., 5 bins) so we can compare the average predicted probability in a bin to the observed frequency of the event in that bin. Good calibration means predicted ≈ observed within each bin.
        </div>
      </div>

      <div class="gloss-item" style="margin-top:8px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-probband" aria-expanded="false">Prob. band ▸</button>
        <div id="gloss-probband" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <strong>Prob. band (95%)</strong>: an approximate 95% confidence interval around a predicted probability, computed as p ± 1.96·sqrt(p(1−p)/n) where n is the sample count used for the estimate. The band shows expected sampling variability — if observed frequency lies outside the band, the prediction may be miscalibrated beyond random noise.
        </div>
      </div>

      <div class="gloss-item" style="margin-top:8px">
        <button type="button" class="gloss-toggle btn small btn-outline" data-target="gloss-howto" aria-expanded="false">How to read these diagnostics ▸</button>
        <div id="gloss-howto" class="gloss-body muted" style="display:none;margin-top:8px" aria-hidden="true">
          <div><strong>Quick guide</strong> — start with the Brier score (lower is better). Then inspect bins:</div>
          <div style="margin-top:6px">- If a bin's predicted probability is higher than the observed frequency, the model is overconfident for that range.</div>
          <div style="margin-top:4px">- If predicted is lower than observed, the model is underconfident.</div>
          <div style="margin-top:4px">- Use the probability band to judge whether deviations could be due to sampling variability: if observed lies inside the band, the difference may be expected by chance; if outside, it's evidence of miscalibration.</div>
        </div>
      </div>
    </div>
  </section>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
  (function(){
    try{
      const defs = {
        'Close': 'Last traded price at market close for the period — the primary price reference used for returns and indicators.',
        'High': 'Highest traded price during the session — useful for range analysis and intraday volatility.',
        'Low': 'Lowest traded price during the session — useful for support/range analysis.',
        'Open': 'First traded price at session open — used to detect gap moves versus previous close.',
        'Volume': 'Total traded shares in the period — liquidity measure used to confirm price moves and volume-weighted signals.',
        'return': 'Arithmetic return for the period: (Close / previous Close − 1). Captures directional percent change.',
        'log_return': 'Natural-log return: ln(Close / previous Close). Additive over time and preferable for some statistical models.',
        'sma_5': '5-period simple moving average of Close — short-term trend baseline (price units).',
        'ema_5': '5-period exponential moving average — short-term trend that weights recent closes more heavily than SMA.',
        'sma_10': '10-period simple moving average — short-to-intermediate trend reference.',
        'ema_10': '10-period exponential moving average — responds faster than SMA10 to recent price moves.',
        'sma_20': '20-period simple moving average — commonly used for intermediate trend filtering.',
        'ema_20': '20-period exponential moving average — intermediate trend indicator with recency bias.',
        'vol_10': 'Rolling realized volatility: standard deviation of returns over 10 periods — a short-term risk/volatility proxy.',
        'rsi_14': 'Relative Strength Index over 14 periods (0–100): momentum oscillator used for overbought/oversold context and divergence.',
        'macd': 'MACD line (typically 12-EMA minus 26-EMA) — momentum/trend indicator in price units.',
        'macd_signal': 'MACD signal line (usually a 9-EMA of MACD) — used for crossover signals and trend smoothing.',
        'macd_hist': 'MACD histogram = MACD − signal — positive values indicate MACD above signal (rising bullish momentum).',
        'lag_close_1': 'Close price one period prior — preserves raw lagged price information for temporal patterns.',
        'lag_return_1': 'Return one period prior — recent return used to capture short-term momentum or mean-reversion.',
        'lag_close_2': 'Close price two periods prior — additional temporal context.',
        'lag_return_2': 'Return two periods prior — historical return signal at lag 2.',
        'lag_close_3': 'Close price three periods prior — extended short-term context.',
        'lag_return_3': 'Return three periods prior — captures slightly older momentum effects.',
        'lag_close_5': 'Close price five periods prior — useful for weekly-style comparisons in daily data.',
        'lag_return_5': 'Return five periods prior — longer short-term return used to capture recent trend persistence.'
      };

      const chips = Array.from(document.querySelectorAll('.feature-chip'));
      const panel = document.getElementById('featureDetail');
      const pName = document.getElementById('featureDetailName');
      const pDef = document.getElementById('featureDetailDef');
      const btnClose = document.getElementById('featureClose');
      const btnCopy = document.getElementById('featureCopy');

      chips.forEach(ch => ch.addEventListener('click', (e) => {
        const feat = ch.getAttribute('data-feature') || ch.title || ch.textContent;
        pName.textContent = feat;
        pDef.textContent = defs[feat] || 'No definition available.';
        panel.style.display = '';
        panel.scrollIntoView({behavior:'smooth', block:'nearest'});
      }));

      btnClose && btnClose.addEventListener('click', ()=>{ if(panel) panel.style.display='none'; });
      btnCopy && btnCopy.addEventListener('click', ()=>{
        const text = pName.textContent + ' — ' + pDef.textContent;
        navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(text) : null;
        btnCopy.textContent = 'Copied';
        setTimeout(()=> btnCopy.textContent = 'Copy', 1200);
      });
    }catch(e){ console.warn('feature token init failed', e); }
  })();
  // Glossary dropdown toggles
  (function(){
    try{
      const toggles = Array.from(document.querySelectorAll('.gloss-toggle'));
      toggles.forEach(btn => {
        const targetId = btn.getAttribute('data-target');
        const target = document.getElementById(targetId);
        btn.addEventListener('click', ()=>{
          if(!target) return;
          const isHidden = target.style.display === 'none' || getComputedStyle(target).display === 'none';
          target.style.display = isHidden ? '' : 'none';
          btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
          target.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
          btn.textContent = btn.textContent.replace(/(▸|▾)$/, '') + (isHidden ? ' ▾' : ' ▸');
        });
      });
    }catch(e){ console.warn('glossary init failed', e); }
  })();
</script>
{% endblock %}