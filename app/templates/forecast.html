{% extends 'base.html' %}
{% block content %}
<section class="section-header">
  <h1>ARIMA Forecast</h1>
  <p class="muted">View persisted forecast from pipeline and generate on-demand forecasts for a chosen horizon.</p>
  <div class="toolbar"><a class="btn" href="/tasks">‚Üê Back to ML Tasks</a></div>
  {% if error %}<p class="alert">{{ error }}</p>{% endif %}
</section>

<div class="grid">
  <div class="panel">
    <h3>Persisted Forecast (Pipeline)</h3>
    {% if forecast %}
      <p><strong>Created:</strong> {{ forecast.created_at }}</p>
      <p><strong>Horizon:</strong> {{ forecast.horizon }} days</p>
      <p><strong>Order:</strong> {{ forecast.order }}</p>
      <p><strong>AIC:</strong> {{ '%.2f'|format(forecast.aic) }} | <strong>BIC:</strong> {{ '%.2f'|format(forecast.bic) }}</p>
      <p><strong>Last Close:</strong> {{ '%.2f'|format(forecast.last_observation) }}</p>
      <details>
        <summary>Predictions ({{ forecast.predictions|length }})</summary>
        <code style="display:block;white-space:pre-wrap">{{ forecast.predictions|map('float')|map('round',2)|list|join(', ') }}</code>
      </details>
      <details>
        <summary>Confidence Intervals</summary>
        <code style="display:block;white-space:pre-wrap">{{ forecast.confidence_interval }}</code>
      </details>
      <div style="margin-top:8px">
        <a class="btn btn-outline" href="/forecast" target="_blank">Open JSON</a>
      </div>
    {% else %}
      <p class="muted">No persisted forecast yet. Run the pipeline to generate one.</p>
    {% endif %}
  </div>
  <div class="panel">
    <h3>Generate New Forecast</h3>
    <form action="/forecast-page" method="post" class="form">
      <div class="form-control">
        <label for="horizon">Horizon (days)</label>
        <input id="horizon" type="number" name="horizon" value="7" min="1" max="30" required />
        <small class="hint">ARIMA(1,1,1) quick forecast; pipeline uses same order.</small>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Forecast</button>
      </div>
    </form>
    {% if computed %}
      <section style="margin-top:12px">
        <h4>On-Demand Result</h4>
        <p><strong>Horizon:</strong> {{ computed.horizon }}</p>
        <p><strong>Order:</strong> {{ computed.order }}</p>
        <p><strong>AIC:</strong> {{ '%.2f'|format(computed.aic) }} | <strong>BIC:</strong> {{ '%.2f'|format(computed.bic) }}</p>
        <p><strong>Last Close:</strong> {{ '%.2f'|format(computed.last_observation) }}</p>
        <details>
          <summary>Predictions</summary>
          <code style="display:block;white-space:pre-wrap">{{ computed.predictions|map('float')|map('round',2)|list|join(', ') }}</code>
        </details>
        <details>
          <summary>Confidence Intervals</summary>
          <code style="display:block;white-space:pre-wrap">{{ computed.confidence_interval }}</code>
        </details>
      </section>
    {% endif %}
  </div>
</div>
{% endblock %}
