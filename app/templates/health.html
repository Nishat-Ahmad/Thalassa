{% extends "base.html" %}
{% block content %}
<section class="section-header">
  <h1>System Health</h1>
  <p class="muted">Live readiness for the API and model artifacts.</p>
</section>

<div class="cards" id="healthCards">
  <div class="card">
    <h3>API Status</h3>
    <p class="hero-title" id="apiStatus" style="margin:4px 0 6px;">{{ status|upper }}</p>
    <p class="muted">Service: <span id="apiService">{{ service }}</span></p>
  </div>
  <div class="card">
    <h3>Server Time</h3>
    <p class="hero-title" id="serverTime" style="margin:4px 0 6px;">{{ time }}</p>
    <p class="muted">UTC</p>
  </div>
  <div class="card">
    <h3>Uptime</h3>
    <p class="hero-title" id="uptimeHuman" style="margin:4px 0 6px;">{{ uptime_human }}</p>
    <p class="muted"><span id="uptimeSeconds">{{ uptime_seconds }}</span> seconds</p>
  </div>
</div>


<div class="panel">
  <div class="section-header">
    <h1>Live Checks</h1>
    <p class="muted">Automatic checks run against important endpoints. Click "Run Pipeline" to trigger a pipeline run for `AAPL`.</p>
  </div>

  <div class="cards">
    <div class="card">
      <h3>Connectivity</h3>
      <p id="pingStatus" class="muted">Checking...</p>
      <div style="margin-top:8px"><a id="pingBtn" class="btn">Ping /</a></div>
    </div>
    <div class="card">
      <h3>Model Artifacts (AAPL)</h3>
      <div id="modelArtifacts" class="muted">Loading...</div>
    </div>
    <div class="card">
      <h3>Pipeline</h3>
      <p id="pipelineStatus" class="muted">Idle</p>
      <div style="margin-top:8px"><button id="runPipeline" class="btn btn-primary">Run Pipeline (AAPL)</button></div>
    </div>
  </div>

  <div class="section-header" style="margin-top:14px">
    <h2>Model Info (raw)</h2>
    <p class="muted">JSON metadata returned from the server for quick inspection.</p>
  </div>
  <pre id="modelJson" style="white-space:pre-wrap;word-break:break-word;background:transparent;border:0;padding:8px;color:var(--muted);max-height:320px;overflow:auto;">Loading...</pre>

</div>

<script>
  async function fetchHealth(){
    try{
      const r = await fetch('/health', { headers: { 'accept':'application/json' } });
      const j = await r.json();
      document.getElementById('apiStatus').textContent = (j.status||'unknown').toUpperCase();
      document.getElementById('apiService').textContent = j.service||'-';
      document.getElementById('serverTime').textContent = j.time||'-';
      document.getElementById('uptimeHuman').textContent = j.uptime_human||'-';
      document.getElementById('uptimeSeconds').textContent = j.uptime_seconds||0;
      document.getElementById('pingStatus').textContent = 'OK';
    }catch(e){
      document.getElementById('apiStatus').textContent = 'DOWN';
      document.getElementById('pingStatus').textContent = 'Error connecting';
    }
  }

  async function fetchModelInfo(){
    try{
      const r = await fetch('/model-info?ticker=AAPL', { headers: { 'accept':'application/json' } });
      const j = await r.json();
      document.getElementById('modelJson').textContent = JSON.stringify(j, null, 2);
      // Display simple artifact list
      const keys = Object.keys(j||{});
      if(!keys.length){
        document.getElementById('modelArtifacts').textContent = 'No model metadata available for AAPL';
        return;
      }
      const lines = keys.map(k => {
        const present = j[k] ? 'ready' : 'missing';
        return `${k}: ${present}`;
      });
      document.getElementById('modelArtifacts').textContent = lines.join('\n');
    }catch(e){
      document.getElementById('modelArtifacts').textContent = 'Error loading model info';
      document.getElementById('modelJson').textContent = ''+e;
    }
  }

  document.getElementById('pingBtn').addEventListener('click', async ()=>{
    document.getElementById('pingStatus').textContent = 'Pinging...';
    try{ await fetch('/'); document.getElementById('pingStatus').textContent = 'OK'; }catch(e){ document.getElementById('pingStatus').textContent = 'Error'; }
  });

  document.getElementById('runPipeline').addEventListener('click', async ()=>{
    const btn = document.getElementById('runPipeline');
    const status = document.getElementById('pipelineStatus');
    btn.disabled = true; status.textContent = 'Running...';
    try{
      const r = await fetch('/run-pipeline?ticker=AAPL', { method: 'POST', headers: { 'accept':'application/json' } });
      const j = await r.json();
      status.textContent = j.status ? `Result: ${j.status}` : 'Completed';
      // refresh model info after run
      setTimeout(fetchModelInfo, 1500);
    }catch(e){ status.textContent = 'Pipeline failed'; }
    btn.disabled = false;
  });

  // initial load and periodic refresh
  fetchHealth(); fetchModelInfo();
  setInterval(fetchHealth, 15000);
  setInterval(fetchModelInfo, 30000);
</script>
{% endblock %}
